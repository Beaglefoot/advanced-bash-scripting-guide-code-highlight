<!DOCTYPE html><html><head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.7.28">
  <title>Redirecting Code Blocks</title>
  <meta name="GENERATOR" content="Modular DocBook HTML Stylesheet Version 1.7">
  <link rel="HOME" title="Advanced Bash-Scripting Guide" href="index.html">
  <link rel="UP" title="I/O Redirection" href="io-redirection.html">
  <link rel="PREVIOUS" title="Using exec" href="x17974.html">
  <link rel="NEXT" title="Applications" href="redirapps.html">
<link rel="stylesheet" href="styles/custom.css"><link rel="stylesheet" href="styles/atom-one-dark.css"></head>
<body class="SECT1" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#840084" alink="#0000FF">
  <div class="NAVHEADER">
    <table summary="Header navigation table" width="100%" border="0" cellpadding="0" cellspacing="0">
      <tbody><tr>
        <th colspan="3" align="center">Advanced Bash-Scripting Guide:</th>
      </tr>
      <tr>
        <td width="10%" align="left" valign="bottom"><a href="x17974.html" accesskey="P">Prev</a></td>
        <td width="80%" align="center" valign="bottom">Chapter 20. I/O Redirection</td>
        <td width="10%" align="right" valign="bottom"><a href="redirapps.html" accesskey="N">Next</a></td>
      </tr>
    </tbody></table>
    <hr align="left" width="100%">
  </div>
  <div class="SECT1">
    <h1 class="SECT1"><a name="REDIRCB" id="REDIRCB"></a>20.2. Redirecting Code Blocks</h1>
    <p><a name="REDIRREF" id="REDIRREF"></a>Blocks of code, such as <a href="loops1.html#WHILELOOPREF">while</a>, <a href="loops1.html#UNTILLOOPREF">until</a>, and <a href="loops1.html#FORLOOPREF1">for</a> loops, even <a href="tests.html#IFTHEN">if/then</a> test blocks can also incorporate redirection of <tt class="FILENAME">stdin</tt>. Even a function may use this form of redirection (see <a href="complexfunct.html#REALNAME">Example 24-11</a>). The <span class="TOKEN">&lt;</span> operator at the end of the code block accomplishes this.</p>
    <div class="EXAMPLE">
      <a name="REDIR2" id="REDIR2"></a>
      <p><b>Example 20-5. Redirected <i class="FIRSTTERM">while</i> loop</b></p>
      <table border="0" bgcolor="#E0E0E0" width="100%">
        <tbody><tr>
          <td>
            <pre class="PROGRAMLISTING hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># redir2.sh</span>

<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ]
<span class="hljs-keyword">then</span>
  Filename=names.data       <span class="hljs-comment"># Default, if no filename specified.</span>
<span class="hljs-keyword">else</span>
  Filename=<span class="hljs-variable">$1</span>
<span class="hljs-keyword">fi</span>  
<span class="hljs-comment">#+ Filename=${1:-names.data}</span>
<span class="hljs-comment">#  can replace the above test (parameter substitution).</span>

count=0

<span class="hljs-built_in">echo</span>

<span class="hljs-keyword">while</span> [ <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> != Smith ]  <span class="hljs-comment"># Why is variable $name in quotes?</span>
<span class="hljs-keyword">do</span>
  <span class="hljs-built_in">read</span> name                 <span class="hljs-comment"># Reads from $Filename, rather than stdin.</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$name</span>
  <span class="hljs-built_in">let</span> <span class="hljs-string">"count += 1"</span>
<span class="hljs-keyword">done</span> &lt;<span class="hljs-string">"<span class="hljs-variable">$Filename</span>"</span>           <span class="hljs-comment"># Redirects stdin to file $Filename. </span>
<span class="hljs-comment">#    ^^^^^^^^^^^^</span>

<span class="hljs-built_in">echo</span>; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$count</span> names read"</span>; <span class="hljs-built_in">echo</span>

<span class="hljs-built_in">exit</span> 0

<span class="hljs-comment">#  Note that in some older shell scripting languages,</span>
<span class="hljs-comment">#+ the redirected loop would run as a subshell.</span>
<span class="hljs-comment">#  Therefore, $count would return 0, the initialized value outside the loop.</span>
<span class="hljs-comment">#  Bash and ksh avoid starting a subshell *whenever possible*,</span>
<span class="hljs-comment">#+ so that this script, for example, runs correctly.</span>
<span class="hljs-comment">#  (Thanks to Heiner Steven for pointing this out.)</span>

<span class="hljs-comment">#  However . . .</span>
<span class="hljs-comment">#  Bash *can* sometimes start a subshell in a PIPED "while-read" loop,</span>
<span class="hljs-comment">#+ as distinct from a REDIRECTED "while" loop.</span>

abc=hi
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"1\n2\n3"</span> | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> l
     <span class="hljs-keyword">do</span> abc=<span class="hljs-string">"<span class="hljs-variable">$l</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-variable">$abc</span>
     <span class="hljs-keyword">done</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$abc</span>

<span class="hljs-comment">#  Thanks, Bruno de Oliveira Schneider, for demonstrating this</span>
<span class="hljs-comment">#+ with the above snippet of code.</span>
<span class="hljs-comment">#  And, thanks, Brian Onn, for correcting an annotation error.</span></pre>
          </td>
        </tr>
      </tbody></table>
    </div>
    <div class="EXAMPLE">
      <a name="REDIR2A" id="REDIR2A"></a>
      <p><b>Example 20-6. Alternate form of redirected <i class="FIRSTTERM">while</i> loop</b></p>
      <table border="0" bgcolor="#E0E0E0" width="100%">
        <tbody><tr>
          <td>
            <pre class="PROGRAMLISTING hljs"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># This is an alternate form of the preceding script.</span>

<span class="hljs-comment">#  Suggested by Heiner Steven</span>
<span class="hljs-comment">#+ as a workaround in those situations when a redirect loop</span>
<span class="hljs-comment">#+ runs as a subshell, and therefore variables inside the loop</span>
<span class="hljs-comment"># +do not keep their values upon loop termination.</span>


<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ]
<span class="hljs-keyword">then</span>
  Filename=names.data     <span class="hljs-comment"># Default, if no filename specified.</span>
<span class="hljs-keyword">else</span>
  Filename=<span class="hljs-variable">$1</span>
<span class="hljs-keyword">fi</span>  


<span class="hljs-built_in">exec</span> 3&lt;&amp;0                 <span class="hljs-comment"># Save stdin to file descriptor 3.</span>
<span class="hljs-built_in">exec</span> 0&lt;<span class="hljs-string">"<span class="hljs-variable">$Filename</span>"</span>        <span class="hljs-comment"># Redirect standard input.</span>

count=0
<span class="hljs-built_in">echo</span>


<span class="hljs-keyword">while</span> [ <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> != Smith ]
<span class="hljs-keyword">do</span>
  <span class="hljs-built_in">read</span> name               <span class="hljs-comment"># Reads from redirected stdin ($Filename).</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$name</span>
  <span class="hljs-built_in">let</span> <span class="hljs-string">"count += 1"</span>
<span class="hljs-keyword">done</span>                      <span class="hljs-comment">#  Loop reads from file $Filename</span>
                          <span class="hljs-comment">#+ because of line 20.</span>

<span class="hljs-comment">#  The original version of this script terminated the "while" loop with</span>
<span class="hljs-comment">#+      done &lt;"$Filename" </span>
<span class="hljs-comment">#  Exercise:</span>
<span class="hljs-comment">#  Why is this unnecessary?</span>


<span class="hljs-built_in">exec</span> 0&lt;&amp;3                 <span class="hljs-comment"># Restore old stdin.</span>
<span class="hljs-built_in">exec</span> 3&lt;&amp;-                 <span class="hljs-comment"># Close temporary fd 3.</span>

<span class="hljs-built_in">echo</span>; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$count</span> names read"</span>; <span class="hljs-built_in">echo</span>

<span class="hljs-built_in">exit</span> 0</pre>
          </td>
        </tr>
      </tbody></table>
    </div>
    <div class="EXAMPLE">
      <a name="REDIR3" id="REDIR3"></a>
      <p><b>Example 20-7. Redirected <i class="FIRSTTERM">until</i> loop</b></p>
      <table border="0" bgcolor="#E0E0E0" width="100%">
        <tbody><tr>
          <td>
            <pre class="PROGRAMLISTING hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># Same as previous example, but with "until" loop.</span>

<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ]
<span class="hljs-keyword">then</span>
  Filename=names.data         <span class="hljs-comment"># Default, if no filename specified.</span>
<span class="hljs-keyword">else</span>
  Filename=<span class="hljs-variable">$1</span>
<span class="hljs-keyword">fi</span>  

<span class="hljs-comment"># while [ "$name" != Smith ]</span>
until [ <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> = Smith ]     <span class="hljs-comment"># Change  !=  to =.</span>
<span class="hljs-keyword">do</span>
  <span class="hljs-built_in">read</span> name                   <span class="hljs-comment"># Reads from $Filename, rather than stdin.</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$name</span>
<span class="hljs-keyword">done</span> &lt;<span class="hljs-string">"<span class="hljs-variable">$Filename</span>"</span>             <span class="hljs-comment"># Redirects stdin to file $Filename. </span>
<span class="hljs-comment">#    ^^^^^^^^^^^^</span>

<span class="hljs-comment"># Same results as with "while" loop in previous example.</span>

<span class="hljs-built_in">exit</span> 0</pre>
          </td>
        </tr>
      </tbody></table>
    </div>
    <div class="EXAMPLE">
      <a name="REDIR4" id="REDIR4"></a>
      <p><b>Example 20-8. Redirected <i class="FIRSTTERM">for</i> loop</b></p>
      <table border="0" bgcolor="#E0E0E0" width="100%">
        <tbody><tr>
          <td>
            <pre class="PROGRAMLISTING hljs"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ]
<span class="hljs-keyword">then</span>
  Filename=names.data          <span class="hljs-comment"># Default, if no filename specified.</span>
<span class="hljs-keyword">else</span>
  Filename=<span class="hljs-variable">$1</span>
<span class="hljs-keyword">fi</span>  

line_count=`wc <span class="hljs-variable">$Filename</span> | awk <span class="hljs-string">'{ print $1 }'</span>`
<span class="hljs-comment">#           Number of lines in target file.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#  Very contrived and kludgy, nevertheless shows that</span>
<span class="hljs-comment">#+ it's possible to redirect stdin within a "for" loop...</span>
<span class="hljs-comment">#+ if you're clever enough.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># More concise is     line_count=$(wc -l &lt; "$Filename")</span>


<span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> `seq <span class="hljs-variable">$line_count</span>`  <span class="hljs-comment"># Recall that "seq" prints sequence of numbers.</span>
<span class="hljs-comment"># while [ "$name" != Smith ]   --   more complicated than a "while" loop   --</span>
<span class="hljs-keyword">do</span>
  <span class="hljs-built_in">read</span> name                    <span class="hljs-comment"># Reads from $Filename, rather than stdin.</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$name</span>
  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> = Smith ]       <span class="hljs-comment"># Need all this extra baggage here.</span>
  <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">break</span>
  <span class="hljs-keyword">fi</span>  
<span class="hljs-keyword">done</span> &lt;<span class="hljs-string">"<span class="hljs-variable">$Filename</span>"</span>              <span class="hljs-comment"># Redirects stdin to file $Filename. </span>
<span class="hljs-comment">#    ^^^^^^^^^^^^</span>

<span class="hljs-built_in">exit</span> 0</pre>
          </td>
        </tr>
      </tbody></table>
    </div>
    <p>We can modify the previous example to also redirect the output of the loop.</p>
    <div class="EXAMPLE">
      <a name="REDIR4A" id="REDIR4A"></a>
      <p><b>Example 20-9. Redirected <i class="FIRSTTERM">for</i> loop (both <tt class="FILENAME">stdin</tt> and <tt class="FILENAME">stdout</tt> redirected)</b></p>
      <table border="0" bgcolor="#E0E0E0" width="100%">
        <tbody><tr>
          <td>
            <pre class="PROGRAMLISTING hljs"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ]
<span class="hljs-keyword">then</span>
  Filename=names.data          <span class="hljs-comment"># Default, if no filename specified.</span>
<span class="hljs-keyword">else</span>
  Filename=<span class="hljs-variable">$1</span>
<span class="hljs-keyword">fi</span>  

Savefile=<span class="hljs-variable">$Filename</span>.new         <span class="hljs-comment"># Filename to save results in.</span>
FinalName=Jonah                <span class="hljs-comment"># Name to terminate "read" on.</span>

line_count=`wc <span class="hljs-variable">$Filename</span> | awk <span class="hljs-string">'{ print $1 }'</span>`  <span class="hljs-comment"># Number of lines in target file.</span>


<span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> `seq <span class="hljs-variable">$line_count</span>`
<span class="hljs-keyword">do</span>
  <span class="hljs-built_in">read</span> name
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span>
  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> = <span class="hljs-string">"<span class="hljs-variable">$FinalName</span>"</span> ]
  <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">break</span>
  <span class="hljs-keyword">fi</span>  
<span class="hljs-keyword">done</span> &lt; <span class="hljs-string">"<span class="hljs-variable">$Filename</span>"</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$Savefile</span>"</span>     <span class="hljs-comment"># Redirects stdin to file $Filename,</span>
<span class="hljs-comment">#    ^^^^^^^^^^^^^^^^^^^^^^^^^^^       and saves it to backup file.</span>

<span class="hljs-built_in">exit</span> 0</pre>
          </td>
        </tr>
      </tbody></table>
    </div>
    <div class="EXAMPLE">
      <a name="REDIR5" id="REDIR5"></a>
      <p><b>Example 20-10. Redirected <i class="FIRSTTERM">if/then</i> test</b></p>
      <table border="0" bgcolor="#E0E0E0" width="100%">
        <tbody><tr>
          <td>
            <pre class="PROGRAMLISTING hljs"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ]
<span class="hljs-keyword">then</span>
  Filename=names.data   <span class="hljs-comment"># Default, if no filename specified.</span>
<span class="hljs-keyword">else</span>
  Filename=<span class="hljs-variable">$1</span>
<span class="hljs-keyword">fi</span>  

TRUE=1

<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$TRUE</span>"</span> ]          <span class="hljs-comment"># if true    and   if :   also work.</span>
<span class="hljs-keyword">then</span>
 <span class="hljs-built_in">read</span> name
 <span class="hljs-built_in">echo</span> <span class="hljs-variable">$name</span>
<span class="hljs-keyword">fi</span> &lt;<span class="hljs-string">"<span class="hljs-variable">$Filename</span>"</span>
<span class="hljs-comment">#  ^^^^^^^^^^^^</span>

<span class="hljs-comment"># Reads only first line of file.</span>
<span class="hljs-comment"># An "if/then" test has no way of iterating unless embedded in a loop.</span>

<span class="hljs-built_in">exit</span> 0</pre>
          </td>
        </tr>
      </tbody></table>
    </div>
    <div class="EXAMPLE">
      <a name="NAMESDATA" id="NAMESDATA"></a>
      <p><b>Example 20-11. Data file <i class="FIRSTTERM">names.data</i> for above examples</b></p>
      <table border="0" bgcolor="#E0E0E0" width="100%">
        <tbody><tr>
          <td>
            <pre class="PROGRAMLISTING hljs">Aristotle
Arrhenius
Belisarius
Capablanca
Dickens
Euler
Goethe
Hegel
Jonah
Laplace
Maroczy
Purcell
Schmidt
Schopenhauer
Semmelweiss
Smith
Steinmetz
Tukhashevsky
Turing
Venn
Warshawski
Znosko-Borowski

<span class="hljs-comment">#  This is a data file for</span>
<span class="hljs-comment">#+ "redir2.sh", "redir3.sh", "redir4.sh", "redir4a.sh", "redir5.sh".</span></pre>
          </td>
        </tr>
      </tbody></table>
    </div>
    <p>Redirecting the <tt class="FILENAME">stdout</tt> of a code block has the effect of saving its output to a file. See <a href="special-chars.html#RPMCHECK">Example 3-2</a>.</p>
    <p><a href="here-docs.html#HEREDOCREF">Here documents</a> are a special case of redirected code blocks. That being the case, it should be possible to feed the output of a <i class="FIRSTTERM">here document</i> into the <tt class="FILENAME">stdin</tt> for a <i class="FIRSTTERM">while loop</i>.</p>
    <table border="0" bgcolor="#E0E0E0" width="100%">
      <tbody><tr>
        <td>
          <pre class="PROGRAMLISTING hljs"><span class="hljs-comment"># This example by Albert Siersema</span>
<span class="hljs-comment"># Used with permission (thanks!).</span>

<span class="hljs-keyword">function</span> doesOutput()
 <span class="hljs-comment"># Could be an external command too, of course.</span>
 <span class="hljs-comment"># Here we show you can use a function as well.</span>
{
  ls -al *.jpg | awk <span class="hljs-string">'{print $5,$9}'</span>
}


nr=0          <span class="hljs-comment">#  We want the while loop to be able to manipulate these and</span>
totalSize=0   <span class="hljs-comment">#+ to be able to see the changes after the 'while' finished.</span>

<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> fileSize fileName ; <span class="hljs-keyword">do</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$fileName</span> is <span class="hljs-variable">$fileSize</span> bytes"</span>
  <span class="hljs-built_in">let</span> nr++
  totalSize=$((totalSize+fileSize))   <span class="hljs-comment"># Or: "let totalSize+=fileSize"</span>
<span class="hljs-keyword">done</span>&lt;&lt;EOF
$(doesOutput)
EOF

<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$nr</span> files totaling <span class="hljs-variable">$totalSize</span> bytes"</span></pre>
        </td>
      </tr>
    </tbody></table>
  </div>
  <div class="NAVFOOTER">
    <hr align="left" width="100%">
    <table summary="Footer navigation table" width="100%" border="0" cellpadding="0" cellspacing="0">
      <tbody><tr>
        <td width="33%" align="left" valign="top"><a href="x17974.html" accesskey="P">Prev</a></td>
        <td width="34%" align="center" valign="top"><a href="index.html" accesskey="H">Home</a></td>
        <td width="33%" align="right" valign="top"><a href="redirapps.html" accesskey="N">Next</a></td>
      </tr>
      <tr>
        <td width="33%" align="left" valign="top">Using <i class="FIRSTTERM">exec</i></td>
        <td width="34%" align="center" valign="top"><a href="io-redirection.html" accesskey="U">Up</a></td>
        <td width="33%" align="right" valign="top">Applications</td>
      </tr>
    </tbody></table>
  </div>


</body></html>
